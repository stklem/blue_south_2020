---
title: "R Notebook"
output: html_notebook
---

## TODO:
* make a variable for intl_inflows and exclude intl_inflows from the normal inflow
* decide on method of visualization

```{r libraries}
library(tidyverse)
library(data.table)
# install.packages("devtools")
# devtools::install_github("UrbanInstitute/urbnmapr")
library(urbnmapr)
```


## Visual Set 1: Movement in and out of the South

### Cleaning
1. Load data
2. Remove margin of error columns
3. Convert the numerical columns from characters to numeric types (removing commas first)
4. Movement outside of the US is only specified at the country level and only includes inflows, not outflows. For simplification, the accompanying NAs in outflow and net migration will be converted to 0
5. Created a separate data table that only include movement that involves southern states

```{r cleaning}
movement_county_to_county <- fread("input/migration_county_to_county_2013_2017.csv")
movement_county_to_county <- select(movement_county_to_county, -ends_with("moe"))
cols_to_change <- 9:ncol(movement_county_to_county)
movement_county_to_county <- filter(movement_county_to_county, is.na(a_state_code) == FALSE)
movement_county_to_county[cols_to_change] <-  as.numeric(str_remove(unlist(movement_county_to_county[cols_to_change]),","))
movement_county_to_county$a_state_name <- as.factor(movement_county_to_county$a_state_name)

# check NAs
lapply(movement_county_to_county, function(x) length(which(is.na(x) == TRUE)))

# convert NAs to 0
movement_county_to_county[cols_to_change] <- as.numeric(replace_na(unlist(movement_county_to_county[cols_to_change]),"0"))

# list of southern states
southern_states <- c(1, 5, 12, 13, 21, 22, 28, 37, 45, 47, 48, 51, 54)
names(southern_states) <- c("AL", "AR", "FL", "GA", "KY", "LA", "MS", "NC", "SC", "TN", "TX", "VA", "WV")    

# filter to include only movements involving southern states
south_county_to_county <- filter(movement_county_to_county, a_state_code %in% southern_states)

```

## All States, Only
Created three summary tables:

| output table    | geography a  | geography b |
|-----------------|:------------:|:-----------:|
| county_to_state | county-level | state-level |
| state_to_state  | state-level  | state-level |
| state_all       | state-level  | -           |

Note: for state_all, inflows - outflows != net migration because we only have inflows from other countries, not outflows

```{r all}
county_to_state <- movement_county_to_county %>% 
  group_by(a_state_code, a_state_name, b_state_code, b_state_name, b_county_fips, b_county_name) %>%
  summarize(inflow = sum(inflow),
            outflow = sum(outflow), 
            net_migration = sum(net_migration))
fwrite(county_to_state, "output/county_to_state.csv")

state_to_state <- movement_county_to_county %>% 
  group_by(a_state_code, a_state_name, b_state_code, b_state_name) %>%
  summarize(inflow = sum(inflow),
            outflow = sum(outflow), 
            net_migration = sum(net_migration))
fwrite(state_to_state, "output/state_to_state.csv")

state_all <- movement_county_to_county %>% 
  group_by(a_state_code, a_state_name) %>%
  summarize(inflow = sum(inflow),
            outflow = sum(outflow), 
            net_migration = sum(net_migration))
fwrite(state_all, "output/state_all.csv")
  
```


## Southern States, Only
| output table           | geography a  | geography b |
|------------------------|:------------:|:-----------:|
| south_ccounty_to_state | county-level | state-level |
| south_cstate_to_state  | state-level  | state-level |
| south_cstate_all       | state-level  | -           |

```{r south}
south_county_to_state <- south_county_to_county %>% 
  group_by(a_state_code, a_state_name, b_state_code, b_state_name, b_county_fips, b_county_name) %>%
  summarize(inflow = sum(inflow),
            outflow = sum(outflow), 
            net_migration = sum(net_migration))
fwrite(south_county_to_state, "output/south_county_to_state.csv")


south_state_to_state <- south_county_to_county %>% 
  group_by(a_state_code, a_state_name, b_state_code, b_state_name) %>%
  summarize(inflow = sum(inflow),
            outflow = sum(outflow), 
            net_migration = sum(net_migration))
fwrite(south_state_to_state, "output/south_state_to_state.csv")


south_state_all <- south_county_to_county %>% 
  group_by(a_state_code, a_state_name) %>%
  summarize(inflow = sum(inflow),
            outflow = sum(outflow), 
            net_migration = sum(net_migration))
fwrite(south_state_all, "output/south_state_all.csv")

```

## Basic Visuals


```{r useful references, include=FALSE}
# https://www.datanovia.com/en/blog/ggplot-colors-best-tricks-you-will-love/#gradient-or-continuous-colors
# https://github.com/UrbanInstitute/urbnmapr
# http://www.endmemo.com/program/R/color.php 
```



```{r basic visuals}
state_all %>%
  mutate(name = fct_reorder(a_state_name, net_migration)) %>%
  ggplot(aes(y = net_migration, x = a_state_name, order_by = net_migration)) +
  geom_bar(stat = "identity") +
  coord_flip()


```

### Choropleth
```{r}
installed.packages("wesanderson")
library(wesanderson)
names(wes_palettes)


states_sf <- get_urbn_map(map = "states", sf = TRUE)

# join w/ movement data
states_all_sf <- full_join(states_sf, state_all, by = c("state_name" = "a_state_name"))

options(scipen = 999)
states_all_sf %>%
  ggplot() +
  geom_sf(mapping = aes(fill = net_migration),
          color = "snow", size = 0.5) +
  scale_fill_gradient2(midpoint = 0, low = "red", mid = "bisque1", high = "royalblue2", 
                       space = "Lab") + 
  labs(title = "Net Migration by State, 2013-2017", fill = "") +
    geom_sf_text(data = get_urbn_labels(map = "states", sf = TRUE), 
                aes(label = state_abbv), size = 3) +
  coord_sf(datum = NA) +
  ggsave("states_net_migration.png", device = "png")

```

